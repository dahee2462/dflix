더블 부킹 문제 연구자료

배경)
스레드 란?>
요청 시 생성되는 실행 단위, 단일 코드 라인 실행
락의 종류> 레코드 락, 갭 락, 넥스트 키 락
	  읽기 잠금(공유 락), 쓰기 잠금(배타 락)
mysql에서 락>
select의 기본 락은 없다. (배타 락 for update, 공유 락 for share)
insert, update, delete는 모두 기본적으로 배타적 넥스트 키 로우 락을 사용한다.



문제와 해결)

new를 계속 찍어서 메모리 차지 -(큰 영향은 없음)
*싱글톤으로 생성(스프링에서는 빈이 한 객체만 생성되는 것이 보장된다.)

---------스레드 계속 생성시 서버 다운 문제 ---------------
*스레드 풀 생성
(기본적으로 스프링 부트에서는 제공하는 tomcat은 스레드 풀을 생성한다.)
그냥 스프링은 스레드 풀 만들어야한다.


---------------스레드-안전-----------------
요청에 의존하는 필드가 싱글톤 내부에 존재하는 경우
여러 요청 정보 유출 문제(statusful 문제) -
*스레드 로컬 변수 사용
스레드 로컬 변수와 스레드 풀을 같이 사용시(톰캣에서는 스레드 풀 기본 장착) 유출 문제-
*스레드 로컬 변수에 남아있는 값 제거 해야함- remove() 메서드 사용
주의-또한 스레드 로컬 변수 사용시 자식 스레드에서 스레드 로컬 변수 사용할 수 없음.

sqlSession 객체는 스레드-안전 하지 않다
스프링에서의 sqlSession은 프록시 사용+ 메소드 호출로 스레드-안전 하다.



---------예약 쿼리문을 실행하는 스레드가 DB에 동시 접근하는 문제(DB 동시성 문제)------
-하나의 서버일 경우

*자료구조중 큐를 통해 예약쿼리를 모두 모아 사용

대상 영화의 상영시간/상영관/좌석에 해당하는 특정 예약 레코드에
하나의 큐가 대응해야하지 않은지?
그렇지 않으면 하나의 예약을 처리하는데 다른 모든 시간/관/좌석의 예약을 기다려야 한다.
그러나 그러면 큐가 너무 많이 생성되게 될 것
*상영관 별로 큐를 생성



----------- 한 트랜잭션에 두개이상 쿼리가 있는 경우 -----------------
(트랜잭션 예시=> 예약이 존재하는지 확인 + 존재하지 않으면 update)

-서버가 여러개일 경우
큐가 서버마다 생성되므로
데이터베이스에 여러 트랜잭션 동시접근가능 문제를 추가로 해결해야한다.
*두개이상의 쿼리를 가진 트랜잭션끼리 데드락이 걸리는지 계산해봐야함

데드락 예방 방법
*트랜잭션에 최소한의 쿼리만 있어야함

*최대한 모든 쿼리를 정해진 순서대로(A->B)

데드락 해결 방법
*락타임아웃 설정
set innodb_lock_wait_timeout = 초단위;
---------------------------------------------------------------------------


DB설계시 주의사항
트랜잭션 중 두개 이상의 쿼리를 가진 트랜잭션끼리 데드락을 최소하기위해
외래키를 최소화 해야함.
해당 자식 테이블이 부모 테이블의 레코드도 잠그거나 잠그는데 영향을 받는다.
(외래키 잠금 전파)

개인적으로 넣으면 좋을거같은 기능)
로그기능
웹소켓기능(처리된 예약내용을 실시간으로 보여줌)
결제 기능(가능하다면)
